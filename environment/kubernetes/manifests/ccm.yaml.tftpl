---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${node_provider_name}-cloud-controller-manager
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: system:${node_provider_name}-cloud-controller-manager
rules:
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch", "update"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["*"]
  - apiGroups: [""]
    resources: ["nodes/status"]
    verbs: ["patch"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["services/status"]
    verbs: ["list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["create", "get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "update", "watch"]
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["create", "get", "list", "watch", "update"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["create", "get", "list", "watch", "update"]
  - apiGroups: [""]
    resources: ["serviceaccounts/token"]
    verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ${node_provider_name}-cloud-controller-manager:${node_provider_name}-apiserver-authentication-reader
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: extension-apiserver-authentication-reader
subjects:
  - kind: ServiceAccount
    name: ${node_provider_name}-cloud-controller-manager
    namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:${node_provider_name}-cloud-controller-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:${node_provider_name}-cloud-controller-manager
subjects:
  - kind: ServiceAccount
    name: ${node_provider_name}-cloud-controller-manager
    namespace: kube-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ${node_provider_name}-cloud-config
  namespace: kube-system
data:
  cloud-config: |
    [Global]
    NLBSecurityGroupMode = Managed
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${node_provider_name}-cloud-controller-manager
  namespace: kube-system
  labels:
    k8s-app: ${node_provider_name}-cloud-controller-manager
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: ${node_provider_name}-cloud-controller-manager
  template:
    metadata:
      labels:
        k8s-app: ${node_provider_name}-cloud-controller-manager
    spec:
      hostNetwork: true
      dnsPolicy: Default
      serviceAccountName: ${node_provider_name}-cloud-controller-manager
      priorityClassName: system-cluster-critical
      nodeSelector:
        vcluster.loft.sh/node-provider: ${node_provider_name}
      containers:
        - name: aws-cloud-controller-manager
          image: registry.k8s.io/provider-aws/cloud-controller-manager:v1.34.0
          args:
            - --v=2
            - --cloud-provider=aws
            - --cloud-config=/etc/kubernetes/cloud-config
            - --use-service-account-credentials=true
            - --configure-cloud-routes=false
            - --leader-elect-resource-name=${node_provider_name}-cloud-controller-manager
            - --cluster-name=${vcluster_name}
          resources:
            requests:
              cpu: "200m"
          volumeMounts:
            - name: cloud-config
              mountPath: /etc/kubernetes
              readOnly: true
      volumes:
        - name: cloud-config
          configMap:
            name: ${node_provider_name}-cloud-config
            items:
              - key: cloud-config
                path: cloud-config
      tolerations:
        - key: node.cloudprovider.kubernetes.io/uninitialized
          operator: Equal
          value: "true"
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          effect: NoSchedule
        - key: karpenter.sh/unregistered
          effect: NoExecute
        - key: node.kubernetes.io/not-ready
          effect: NoSchedule
        - key: "vcluster.com/cleanup"
          operator: "Exists"
          effect: "NoExecute"
